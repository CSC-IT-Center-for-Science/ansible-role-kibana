---

  - name: template in kibana yum repo config
    template: src=kibana.repo dest=/etc/yum.repos.d/kibana.repo mode=0644
    when: kibana_branch != "5.x"

  - name: install kibana 
    package: name=kibana state=installed

  - name: send in kibana4's config.yml
    template: src={{ kibana4_config_yml }} dest=/opt/kibana/config/kibana.yml owner=kibana group=kibana mode=0644 backup=yes
    register: reg_kibana4_config_file
    when: kibana_branch != "5.x"

  - name: send in kibana5's config.yml
    template: src={{ kibana5_config_yml }} dest=/etc/kibana/kibana.yml owner=kibana group=kibana mode=0644 backup=yes
    register: reg_kibana5_config_file
    when: kibana_branch == "5.x"

  - name: grab cluster health
    action: uri url=http://localhost:{{ es_http_port }}/_cluster/health return_content=yes
    register: clusterhealth

  - name: Display cluster health
    debug: var=clusterhealth

  - name: install kibana 4.x plugins 
    command: /opt/kibana/bin/kibana plugin -i {{ item }}
    when: kibana4_plugins.0 != "" and kibana_branch != "5.x"
    with_items: "{{Â kibana4_plugins }}"
    register: kibana4_plugin_install
    ignore_errors: True

  - name: set kibana user as owner recursively in /opt/kibana/optimize
    file: path=/opt/kibana/optimize state=directory owner=kibana recurse=yes
    when: kibana_branch != "5.x"

  - name: Display kibana_plugin_install
    debug: var=kibana4_plugin_install
    when: kibana_branch == "5.x"

  - name: start kibana service
    service: name=kibana enabled=yes state=started

  - name: restart kibana service if plugin was installed
    service: name=kibana state=restarted
    when: kibana4_plugin_install.changed and (kibana4_plugin_install.failed is defined and kibana4_plugin_install.failed != True) and kibana_branch != "5.x"

  - name: restart kibana service if config changed
    service: name=kibana state=restarted
    when: reg_kibana4_config_file.changed or reg_kibana5_config_file.changed
